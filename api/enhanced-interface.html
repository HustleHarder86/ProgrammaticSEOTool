<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programmatic SEO Tool - Pro Version</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f0f2f5; 
            padding: 20px;
            line-height: 1.6;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        
        .workflow {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .section { 
            background: white; 
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .section:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        
        h2 { 
            color: #333; 
            margin-bottom: 20px; 
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        input, textarea, select { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 15px; 
            border: 2px solid #e1e4e8; 
            border-radius: 6px; 
            font-size: 14px;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button { 
            background: #667eea; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        button:hover { background: #5a67d8; transform: translateY(-1px); }
        button:disabled { 
            background: #cbd5e0; 
            cursor: not-allowed; 
            transform: none;
        }
        
        .secondary-btn {
            background: #e2e8f0;
            color: #4a5568;
        }
        .secondary-btn:hover { background: #cbd5e0; }
        
        .result { 
            margin-top: 20px; 
            padding: 20px; 
            background: #f7fafc; 
            border-radius: 6px; 
            border: 1px solid #e2e8f0;
        }
        
        .keywords-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .keyword-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .keyword-card:hover { 
            border-color: #667eea; 
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        .keyword-card.selected {
            background: #f0f4ff;
            border-color: #667eea;
        }
        
        /* Clustering styles */
        .cluster-container {
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }
        .cluster-header {
            background: #f7fafc;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .cluster-header:hover {
            background: #edf2f7;
        }
        .cluster-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #2d3748;
        }
        .cluster-icon {
            font-size: 1.2em;
        }
        .cluster-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            color: #718096;
        }
        .cluster-content {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
        }
        .cluster-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .cluster-collapsed .cluster-content {
            display: none;
        }
        .cluster-toggle {
            transition: transform 0.2s;
        }
        .cluster-collapsed .cluster-toggle {
            transform: rotate(-90deg);
        }
        .keyword-card h4 { 
            color: #2d3748; 
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        .keyword-metrics {
            display: flex;
            gap: 15px;
            font-size: 0.85em;
            color: #718096;
        }
        .metric {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .content-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
        }
        .content-item h3 { 
            color: #2d3748; 
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .content-meta {
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 10px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 4px;
        }
        .content-preview {
            color: #4a5568;
            line-height: 1.6;
        }
        
        /* Quality indicators */
        .quality-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 10px;
        }
        .quality-high {
            background: #d4f8e8;
            color: #065f46;
        }
        .quality-medium {
            background: #fef3c7;
            color: #92400e;
        }
        .quality-low {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .uniqueness-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #4b5563;
        }
        .uniqueness-bar {
            width: 100px;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .uniqueness-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s ease;
        }
        
        .export-section {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #718096;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .loading { 
            color: #667eea; 
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .error { 
            color: #e53e3e; 
            background: #fff5f5;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #feb2b2;
        }
        .success { 
            color: #38a169; 
            background: #f0fff4;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #9ae6b4;
        }
        
        /* Loading spinner */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Icons */
        .icon { width: 20px; height: 20px; vertical-align: middle; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #718096;
        }
        .close-modal:hover { color: #2d3748; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Programmatic SEO Tool Pro</h1>
            <p>Generate hundreds of SEO-optimized pages with AI-powered content</p>
            <div style="margin-top: 15px;">
                <a href="/dashboard" target="_blank" style="color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 6px; display: inline-block;">
                    üìä View API Usage Dashboard ‚Üí
                </a>
            </div>
        </div>

        <!-- Stats Dashboard -->
        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="statKeywords">0</div>
                <div class="stat-label">Keywords Found</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statContent">0</div>
                <div class="stat-label">Content Generated</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statSelected">0</div>
                <div class="stat-label">Selected Items</div>
            </div>
        </div>

        <div class="workflow">
            <!-- Step 1: Analyze Business -->
            <div class="section">
                <h2><span class="step-number">1</span> Analyze Your Business</h2>
                <input type="url" id="businessUrl" placeholder="https://yourbusiness.com (optional)">
                <textarea id="businessDesc" rows="4" placeholder="Describe your business, products, services, and target audience..."></textarea>
                
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <select id="targetAudience" style="flex: 1;">
                        <option value="auto">Auto-detect Target Audience</option>
                        <option value="multi_project">üéØ Create Both B2B & B2C Projects</option>
                        <option value="b2b_realtors">B2B Only - Real Estate Agents</option>
                        <option value="investors">B2C Only - Property Investors</option>
                        <option value="home_buyers">Home Buyers</option>
                        <option value="b2b_saas">B2B SaaS Customers</option>
                        <option value="ecommerce">E-commerce Shoppers</option>
                    </select>
                    <select id="contentType" style="flex: 1;">
                        <option value="all">All Content Types</option>
                        <option value="blog">Blog Posts</option>
                        <option value="landing">Landing Pages</option>
                        <option value="comparison">Comparison Pages</option>
                        <option value="guide">How-to Guides</option>
                    </select>
                </div>
                
                <button onclick="analyzeBusiness()">
                    <span>üîç</span> Analyze Business
                </button>
                <div id="analyzeResult"></div>
            </div>

            <!-- Step 2: Generate Keywords -->
            <div class="section">
                <h2><span class="step-number">2</span> Generate Keywords - Programmatic Seeds</h2>
                
                <!-- Seed Keywords Tab -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button id="seedModeBtn" onclick="toggleKeywordMode('seed')" style="flex: 1; background: #667eea;">
                        üå± Seed Mode (100s-1000s)
                    </button>
                    <button id="basicModeBtn" onclick="toggleKeywordMode('basic')" style="flex: 1; background: #e2e8f0; color: #333;">
                        üìù Basic Mode (10s-100s)
                    </button>
                </div>
                
                <!-- Seed Mode Content -->
                <div id="seedModeContent">
                    <div style="background: #f0f4ff; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0;">üöÄ Programmatic SEO - Seed Keywords</h4>
                        <p style="margin: 0; font-size: 0.9em;">Select seed templates to generate hundreds or thousands of keyword variations automatically.</p>
                    </div>
                    
                    <div id="seedTemplates" style="margin-bottom: 15px;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <div style="background: #e6f7ff; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                        <strong>Estimated Total Keywords: </strong>
                        <span id="estimatedKeywords" style="font-size: 1.2em; color: #1890ff;">0</span>
                    </div>
                    
                    <button onclick="generateFromSeeds()" style="width: 100%;">
                        üå± Generate All Variations
                    </button>
                </div>
                
                <!-- Basic Mode Content -->
                <div id="basicModeContent" style="display: none;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="number" id="numKeywords" value="20" min="5" max="100" style="width: 100px;">
                        <select id="keywordIntent" style="flex: 1;">
                            <option value="all">All Intents</option>
                            <option value="informational">Informational</option>
                            <option value="commercial">Commercial</option>
                            <option value="transactional">Transactional</option>
                        </select>
                    </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="autoCluster" checked>
                        <span>Auto-cluster keywords by topic</span>
                    </label>
                    <select id="clusterMethod" style="margin-top: 10px; width: 200px;">
                        <option value="semantic">Semantic Similarity</option>
                        <option value="intent">Search Intent</option>
                        <option value="pattern">Keyword Pattern</option>
                    </select>
                </div>
                <button onclick="generateKeywords()" id="keywordBtn" disabled>
                    <span>üéØ</span> Generate Keywords
                </button>
                <button onclick="selectAllKeywords()" class="secondary-btn" id="selectAllBtn" style="display:none;">
                    Select All
                </button>
                <button onclick="toggleView()" class="secondary-btn" id="viewToggleBtn" style="display:none;">
                    <span id="viewToggleIcon">üìä</span> <span id="viewToggleText">List View</span>
                </button>
                <div id="keywordResult"></div>
            </div>

            <!-- Step 3: Generate Content -->
            <div class="section">
                <h2><span class="step-number">3</span> Generate Content</h2>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 10px;">
                        How many articles to generate now?
                    </label>
                    <input type="number" id="articlesToGenerate" value="5" min="1" max="50" style="width: 100px; margin-bottom: 10px;">
                    <div style="font-size: 0.85em; color: #718096;">
                        <span id="remainingKeywords">0</span> keywords selected
                        <span id="previouslyGenerated" style="display: none;"> ‚Ä¢ <strong></strong> already generated</span>
                    </div>
                </div>
                
                <!-- Quality Settings -->
                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px;">Quality Settings</h4>
                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <input type="checkbox" id="ensureUniqueness" checked>
                        <span>Ensure content uniqueness (avoid duplicate content)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <input type="checkbox" id="addUniqueElements" checked>
                        <span>Add unique elements (infographics, data, examples)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="varyStructure" checked>
                        <span>Vary content structure per article</span>
                    </label>
                    <div style="margin-top: 10px;">
                        <label>Minimum word count: 
                            <input type="number" id="minWordCount" value="1500" min="800" max="3000" style="width: 80px;">
                        </label>
                    </div>
                </div>
                
                <button onclick="generateContent()" id="contentBtn" disabled>
                    <span>üìù</span> Generate Content
                </button>
                <button onclick="exportContent()" class="secondary-btn" id="exportBtn" style="display:none;">
                    <span>üíæ</span> Export All
                </button>
                <button onclick="showGenerationHistory()" class="secondary-btn" id="historyBtn" style="display:none;">
                    <span>üìú</span> History
                </button>
                <div id="contentResult"></div>
            </div>
        </div>

        <!-- Projects Section -->
        <div class="section">
            <h2>üìÅ Saved Projects</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="projectName" placeholder="Project name..." style="flex: 1;">
                <button onclick="saveProject()" id="saveBtn" disabled>Save Current</button>
                <button onclick="loadProjects()" class="secondary-btn">Refresh</button>
            </div>
            <div id="projectsList"></div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2>Export Content</h2>
            <div style="margin: 20px 0;">
                <button onclick="downloadCSV()">üìä Download CSV</button>
                <button onclick="downloadJSON()">üìÑ Download JSON</button>
                <button onclick="copyToClipboard()" class="secondary-btn">üìã Copy All</button>
            </div>
            <textarea id="exportPreview" rows="10" readonly style="font-family: monospace; font-size: 12px;"></textarea>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let businessInfo = null;
        let allKeywords = [];
        let selectedKeywords = [];
        let generatedContent = [];
        let generationHistory = {}; // Track which keywords have been generated
        let keywordClusters = {}; // Store clustered keywords
        let clusterView = true; // Toggle between cluster and list view
        let multiProjectMode = false;
        let currentProjects = {}; // Store B2B and B2C projects
        let seedKeywords = []; // Store seed configurations
        let keywordMode = 'seed'; // 'seed' or 'basic'

        // Initialize
        window.onload = () => {
            loadProjects();
            updateStats();
            loadSeedTemplates();
        };
        
        function updateBusinessContext(event) {
            const marketContext = document.getElementById('marketContext').value;
            const locationContext = document.getElementById('locationContext').value;
            const additionalContext = document.getElementById('additionalContext').value;
            
            // Update business info with context
            if (marketContext) {
                businessInfo.market_context = marketContext;
            }
            
            if (locationContext) {
                // Parse locations and store as array
                businessInfo.target_locations = locationContext.split(',').map(loc => loc.trim()).filter(loc => loc);
                // Use first location as primary
                if (businessInfo.target_locations.length > 0) {
                    businessInfo.location = businessInfo.target_locations[0];
                }
            }
            
            if (additionalContext) {
                businessInfo.additional_context = additionalContext;
            }
            
            // Update display
            const contextDisplay = document.createElement('div');
            contextDisplay.style.cssText = 'margin-top: 10px; padding: 10px; background: #f0fff4; border-radius: 4px;';
            contextDisplay.innerHTML = `
                <strong>‚úì Context Updated:</strong><br>
                ${marketContext ? `Market: ${marketContext}<br>` : ''}
                ${locationContext ? `Locations: ${businessInfo.target_locations.join(', ')}<br>` : ''}
                ${additionalContext ? `Context: ${additionalContext}` : ''}
            `;
            
            // Insert after the update button
            const updateBtn = event ? event.target : document.querySelector('button[onclick*="updateBusinessContext"]');
            if (updateBtn && updateBtn.parentNode) {
                updateBtn.parentNode.appendChild(contextDisplay);
            }
            
            // Disable inputs to show they've been saved
            document.getElementById('marketContext').style.background = '#f0fff4';
            document.getElementById('locationContext').style.background = '#f0fff4';
            document.getElementById('additionalContext').style.background = '#f0fff4';
        }
        
        function toggleKeywordMode(mode) {
            keywordMode = mode;
            
            if (mode === 'seed') {
                document.getElementById('seedModeBtn').style.background = '#667eea';
                document.getElementById('seedModeBtn').style.color = 'white';
                document.getElementById('basicModeBtn').style.background = '#e2e8f0';
                document.getElementById('basicModeBtn').style.color = '#333';
                document.getElementById('seedModeContent').style.display = 'block';
                document.getElementById('basicModeContent').style.display = 'none';
            } else {
                document.getElementById('basicModeBtn').style.background = '#667eea';
                document.getElementById('basicModeBtn').style.color = 'white';
                document.getElementById('seedModeBtn').style.background = '#e2e8f0';
                document.getElementById('seedModeBtn').style.color = '#333';
                document.getElementById('seedModeContent').style.display = 'none';
                document.getElementById('basicModeContent').style.display = 'block';
            }
        }
        
        async function loadSeedTemplates() {
            const templatesDiv = document.getElementById('seedTemplates');
            
            // Show loading state
            templatesDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: #666;">ü§ñ AI is analyzing your business to create custom SEO templates...</p>
                </div>
            `;
            
            // First, get intelligent seed suggestions from the API
            let seedTemplates = [];
            
            if (businessInfo) {
                try {
                    console.log('Requesting AI-generated seed templates...');
                    const response = await fetch(`${API_URL}/api/generate-keywords`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            business_info: businessInfo,
                            get_suggestions: true
                        })
                    });
                    
                    const data = await response.json();
                    console.log('Seed suggestions response:', data);
                    
                    if (data.seed_suggestions && data.seed_suggestions.length > 0) {
                        seedTemplates = data.seed_suggestions;
                        console.log(`Received ${seedTemplates.length} AI-generated templates`);
                    }
                } catch (error) {
                    console.error('Failed to get seed suggestions:', error);
                }
            }
            
            // Fallback to generic templates if no suggestions
            if (seedTemplates.length === 0) {
                seedTemplates = [
                    {
                        id: 'location_based',
                        name: 'üìç Location-Based Keywords',
                        template: '{location} {service}',
                        description: 'Generate location-specific keywords for your business',
                        estimated_keywords: '500-2000',
                        example: 'Best [your business] in Austin, [your service] near me Dallas'
                    },
                    {
                        id: 'comparison_based',
                        name: '‚öñÔ∏è Comparison Keywords',
                        template: '{item1} vs {item2} for {use_case}',
                        description: 'Compare your business with competitors or alternatives',
                    variables: {
                        metrics: 15,
                        locations: 50,
                        years: 2
                    },
                    estimated: 15 * 50 * 2,
                    example: 'rental roi calculator Austin 2024'
                },
                {
                    id: 'tool_based',
                    name: 'üõ†Ô∏è Tool & Calculator Keywords',
                    template: '{tool_type} for {use_case}',
                    description: 'Tool and calculator related keywords',
                    estimated_keywords: '1000-3000',
                    example: 'ROI calculator for real estate investment'
                },
                {
                    id: 'how_to_based',
                    name: 'üìñ How-To Keywords',
                    template: 'how to {action} {target}',
                    description: 'Educational and guide keywords',
                    estimated_keywords: '800-2000',
                    example: 'How to analyze real estate deals'
                }
            ];
            
            // Add header if AI-generated
            let html = '';
            if (seedTemplates.some(t => t.relevance === 'high')) {
                html = `
                    <div style="background: #f0fff4; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                        <strong>‚ú® AI-Generated Templates</strong>
                        <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #666;">
                            These templates were custom-created for your business using AI analysis
                        </p>
                    </div>
                `;
            }
            
            seedTemplates.forEach((template, index) => {
                const isAiGenerated = template.relevance === 'high';
                html += `
                    <div style="border: 1px solid ${isAiGenerated ? '#52c41a' : '#e2e8f0'}; padding: 15px; border-radius: 8px; margin-bottom: 10px; ${isAiGenerated ? 'background: #fafff7;' : ''}">
                        ${isAiGenerated ? '<span style="background: #52c41a; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; float: right;">AI CUSTOM</span>' : ''}
                        <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="seed_${template.id}" onchange="updateSeedEstimate()" style="margin-top: 2px;" ${index === 0 ? 'checked' : ''}>
                            <div style="flex: 1;">
                                <h4 style="margin: 0;">${template.name}</h4>
                                <p style="margin: 5px 0; color: #666; font-size: 0.9em;">${template.description}</p>
                                ${template.templates && template.templates.length > 0 ? 
                                    `<div style="margin: 8px 0;">
                                        <strong style="font-size: 0.85em;">Template patterns:</strong>
                                        <div style="margin-top: 5px;">
                                            ${template.templates.slice(0, 3).map(t => 
                                                `<code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-right: 5px; display: inline-block; margin-bottom: 3px;">${t}</code>`
                                            ).join('')}
                                            ${template.templates.length > 3 ? '<span style="font-size: 0.8em; color: #888;">...</span>' : ''}
                                        </div>
                                    </div>` : 
                                    (template.template ? `<code style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">${template.template}</code>` : '')
                                }
                                <div style="margin-top: 8px; font-size: 0.85em; color: #888;">
                                    <strong>Estimated Keywords:</strong> 
                                    <strong style="color: #1890ff;">${template.estimated_keywords || template.estimated || '100+'}</strong>
                                </div>
                                <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                                    <em>Example: ${template.example}</em>
                                </div>
                            </div>
                        </label>
                    </div>
                `;
            });
            
            templatesDiv.innerHTML = html;
            
            // Auto-update estimate if first template is checked
            if (seedTemplates.length > 0) {
                updateSeedEstimate();
            }
        }
        }
        
        function updateSeedEstimate() {
            let total = 0;
            
            // Get all checked seed checkboxes
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="seed_"]:checked');
            
            checkboxes.forEach(checkbox => {
                // Try to find the estimated count from the template's displayed text
                const templateDiv = checkbox.closest('div').querySelector('strong[style*="color: #1890ff"]');
                if (templateDiv) {
                    const estimatedText = templateDiv.textContent;
                    // Handle ranges like "500-2000" by taking the max value
                    if (estimatedText.includes('-')) {
                        const values = estimatedText.split('-').map(v => parseInt(v.replace(/\D/g, '')) || 0);
                        total += Math.max(...values);
                    } else {
                        // Handle single numbers
                        const value = parseInt(estimatedText.replace(/\D/g, '')) || 100;
                        total += value;
                    }
                }
            });
            
            document.getElementById('estimatedKeywords').textContent = total.toLocaleString();
        }
        
        async function generateFromSeeds() {
            if (!businessInfo) {
                alert('Please analyze your business first');
                return;
            }
            
            // Get selected seeds
            const selectedSeeds = [];
            
            // Get all checkboxes that start with 'seed_'
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="seed_"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    // Extract the ID without the 'seed_' prefix
                    const seedId = checkbox.id.replace('seed_', '');
                    selectedSeeds.push(seedId);
                }
            });
            
            if (selectedSeeds.length === 0) {
                alert('Please select at least one seed template');
                return;
            }
            
            const resultDiv = document.getElementById('keywordResult');
            resultDiv.innerHTML = '<p class="loading"><span class="spinner"></span> Generating keyword variations from seeds...</p>';
            
            try {
                // Get market context
                const marketContext = document.getElementById('marketContext').value || '';
                const locationList = document.getElementById('locationContext').value || '';
                const additionalContext = document.getElementById('additionalContext').value || '';
                
                console.log('Sending seed request with:', {
                    selectedSeeds,
                    businessInfo,
                    marketContext,
                    locationList
                });
                
                const response = await fetch(`${API_URL}/api/generate-keywords`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        business_info: businessInfo,
                        seed_mode: true,
                        selected_seeds: selectedSeeds,
                        location: businessInfo.location || 'online',
                        market_context: marketContext,
                        location_list: locationList,
                        additional_context: additionalContext
                    })
                });
                
                const data = await response.json();
                console.log('API Response:', data);
                
                if (data.seed_results) {
                    renderSeedResults(data.seed_results);
                    return;
                } else if (data.keywords && data.keywords.length > 0) {
                    // Fallback to regular keywords
                    allKeywords = data.keywords;
                    renderKeywords();
                    updateStats();
                    
                    // Show cost estimate
                    showCostNotification('generate_keywords', 0.0050);
                } else {
                    // No results
                    resultDiv.innerHTML = `<div class="error">No keywords generated. Please check your seed selection and try again.</div>`;
                }
            } catch (error) {
                console.error('Seed generation error:', error);
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        function renderSeedResults(seedResults) {
            const resultDiv = document.getElementById('keywordResult');
            
            let html = `
                <div class="success" style="margin-bottom: 20px;">
                    ‚úì Generated ${seedResults.summary.total_variations.toLocaleString()} keyword variations!
                </div>
                
                <div style="background: #f0fff4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0;">üå± Programmatic SEO Results</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            `;
            
            // Show breakdown by category
            Object.entries(seedResults.summary.by_category).forEach(([category, count]) => {
                html += `
                    <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <h4 style="margin: 0; color: #667eea;">${count.toLocaleString()}</h4>
                        <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #666;">${category.replace('_', ' ').toUpperCase()}</p>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Seed Template Details:</h4>
            `;
            
            // Show seed details
            seedResults.seed_details.forEach(seed => {
                html += `
                    <div style="background: #f7f9fc; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                        <strong>${seed.category}</strong>
                        <div style="margin-top: 5px; font-size: 0.9em; color: #666;">
                            ${seed.template_count} templates √ó ${seed.variable_combinations} combinations = 
                            <strong>${seed.total_variations.toLocaleString()} keywords</strong>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div style="background: #e6f7ff; padding: 15px; border-radius: 6px;">
                    <h4 style="margin: 0 0 10px 0;">Sample Keywords (First 50):</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            `;
            
            // Show sample keywords
            seedResults.keywords.slice(0, 50).forEach(kw => {
                html += `<span style="background: white; padding: 4px 12px; border-radius: 4px; font-size: 0.85em; border: 1px solid #d9d9d9;">${kw.keyword}</span>`;
            });
            
            html += `
                    </div>
                    ${seedResults.keywords.length > 50 ? `<p style="margin: 10px 0 0 0; color: #666; font-style: italic;">...and ${(seedResults.keywords.length - 50).toLocaleString()} more keywords</p>` : ''}
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="downloadSeedKeywords()" style="width: 100%;">
                        üì• Download All ${seedResults.summary.total_variations.toLocaleString()} Keywords
                    </button>
                </div>
            `;
            
            resultDiv.innerHTML = html;
            
            // Store for content generation
            allKeywords = seedResults.keywords.map(k => ({
                keyword: k.keyword,
                search_volume: Math.floor(Math.random() * 1000) + 100,
                difficulty: Math.floor(Math.random() * 30) + 20,
                intent: 'informational',
                cpc: Math.random() * 5 + 0.5,
                seed_category: k.seed_category
            }));
            
            document.getElementById('contentBtn').disabled = false;
            updateStats();
            
            // Automatically cluster the keywords
            clusterView = true;
            document.getElementById('clusterMethod').value = 'semantic'; // Use semantic clustering for seed results
            clusterKeywords();
            
            // Show cluster view
            document.getElementById('viewToggleBtn').style.display = 'inline-block';
            document.getElementById('selectAllBtn').style.display = 'inline-block';
            
            // Show success message
            showCostNotification('generate_keywords_seed', 0.0050);
        }

        function updateStats() {
            document.getElementById('statKeywords').textContent = allKeywords.length;
            document.getElementById('statContent').textContent = generatedContent.length;
            document.getElementById('statSelected').textContent = selectedKeywords.length;
            document.getElementById('stats').style.display = allKeywords.length > 0 ? 'grid' : 'none';
            
            // Update remaining keywords count
            const remaining = selectedKeywords.filter(kw => !generationHistory[kw]).length;
            const generated = selectedKeywords.filter(kw => generationHistory[kw]).length;
            
            if (document.getElementById('remainingKeywords')) {
                document.getElementById('remainingKeywords').textContent = `${remaining} keywords remaining`;
            }
            
            if (generated > 0 && document.getElementById('previouslyGenerated')) {
                const genSpan = document.getElementById('previouslyGenerated');
                genSpan.style.display = 'inline';
                genSpan.querySelector('strong').textContent = `${generated}`;
            }
        }
        
        function renderMultiProjectKeywords(projects) {
            const resultDiv = document.getElementById('keywordResult');
            
            let html = `
                <div class="success" style="margin-bottom: 20px;">
                    ‚úì Generated ${projects.summary.total_keywords} keywords across 2 target audiences!
                </div>
                
                <div style="background: #f7f9fc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0;">üìä Multi-Project Summary</h3>
                    <p style="margin: 5px 0;"><strong>B2B Keywords:</strong> ${projects.summary.b2b_keywords} for Real Estate Professionals</p>
                    <p style="margin: 5px 0;"><strong>B2C Keywords:</strong> ${projects.summary.b2c_keywords} for Property Investors</p>
                    <p style="margin: 10px 0 0 0; font-style: italic;">${projects.summary.recommended_approach}</p>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button onclick="selectProject('b2b')" id="b2bBtn" style="flex: 1;">
                        üè¢ View B2B Keywords
                    </button>
                    <button onclick="selectProject('b2c')" id="b2cBtn" style="flex: 1;">
                        üè† View B2C Keywords
                    </button>
                    <button onclick="selectProject('both')" id="bothBtn" style="flex: 1;">
                        üéØ View Both Projects
                    </button>
                </div>
                
                <div id="projectContent"></div>
            `;
            
            resultDiv.innerHTML = html;
            
            // Default to showing both
            selectProject('both');
        }
        
        function selectProject(type) {
            // Update button states
            document.getElementById('b2bBtn').style.background = type === 'b2b' ? '#667eea' : '#e2e8f0';
            document.getElementById('b2cBtn').style.background = type === 'b2c' ? '#667eea' : '#e2e8f0';
            document.getElementById('bothBtn').style.background = type === 'both' ? '#667eea' : '#e2e8f0';
            
            const contentDiv = document.getElementById('projectContent');
            
            if (type === 'both') {
                // Show both projects side by side
                contentDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3>üè¢ B2B - ${currentProjects.b2b_project.name}</h3>
                            <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">${currentProjects.b2b_project.description}</p>
                            ${renderProjectClusters(currentProjects.b2b_project, 'b2b')}
                        </div>
                        <div>
                            <h3>üè† B2C - ${currentProjects.b2c_project.name}</h3>
                            <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">${currentProjects.b2c_project.description}</p>
                            ${renderProjectClusters(currentProjects.b2c_project, 'b2c')}
                        </div>
                    </div>
                `;
            } else {
                // Show single project
                const project = type === 'b2b' ? currentProjects.b2b_project : currentProjects.b2c_project;
                const icon = type === 'b2b' ? 'üè¢' : 'üè†';
                
                // Set allKeywords for other functions to work
                allKeywords = project.keywords;
                keywordClusters = project.clusters;
                
                contentDiv.innerHTML = `
                    <h3>${icon} ${project.name}</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">${project.description}</p>
                    ${renderProjectClusters(project, type)}
                    
                    <div style="margin-top: 20px;">
                        <button onclick="generateContentForProject('${type}')" style="width: 100%;">
                            üìù Generate Content for ${type.toUpperCase()} Keywords
                        </button>
                    </div>
                `;
                
                // Enable content generation
                document.getElementById('contentBtn').disabled = false;
                updateStats();
            }
        }
        
        function renderProjectClusters(project, projectType) {
            let html = '<div class="clusters-container">';
            
            Object.entries(project.clusters).forEach(([clusterId, cluster]) => {
                const totalVolume = cluster.keywords.reduce((sum, k) => sum + k.search_volume, 0);
                const avgCPC = (cluster.keywords.reduce((sum, k) => sum + k.cpc, 0) / cluster.keywords.length).toFixed(2);
                
                html += `
                    <div class="cluster-card">
                        <div class="cluster-header">
                            <h4>${cluster.icon || 'üìÅ'} ${cluster.name}</h4>
                            <span class="cluster-count">${cluster.keywords.length} keywords</span>
                        </div>
                        <div class="cluster-stats">
                            <span>Total Volume: ${totalVolume.toLocaleString()}</span>
                            <span>Avg CPC: $${avgCPC}</span>
                        </div>
                        <div class="cluster-keywords" style="max-height: 200px; overflow-y: auto;">
                            ${cluster.keywords.slice(0, 5).map(kw => `
                                <div class="keyword-preview" style="padding: 5px; border-bottom: 1px solid #eee;">
                                    <div style="font-size: 0.9em;">${kw.keyword}</div>
                                    <div style="font-size: 0.8em; color: #666;">
                                        Vol: ${kw.search_volume} | Diff: ${kw.difficulty}% | CPC: $${kw.cpc}
                                    </div>
                                </div>
                            `).join('')}
                            ${cluster.keywords.length > 5 ? `<div style="padding: 5px; text-align: center; color: #667eea;">+${cluster.keywords.length - 5} more...</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        async function analyzeBusiness() {
            try {
                const url = document.getElementById('businessUrl').value;
                let desc = document.getElementById('businessDesc').value;
                const contentType = document.getElementById('contentType').value;
                const targetAudience = document.getElementById('targetAudience').value;
                const resultDiv = document.getElementById('analyzeResult');
                
                if (!url && !desc) {
                    resultDiv.innerHTML = '<p class="error">Please enter a URL or description</p>';
                    return;
                }
                
                console.log('Analyzing business:', url || desc);
                
                // If only URL provided, add a default description
                if (url && !desc) {
                    desc = "Real estate investment analysis tool";
                }
                
                resultDiv.innerHTML = '<p class="loading"><span class="spinner"></span> Analyzing with AI...</p>';
                
                const response = await fetch(`${API_URL}/api/analyze-business`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        business_url: url,
                        business_description: desc,
                        target_audience: targetAudience
                    })
                });
                
                const data = await response.json();
                businessInfo = data.business_info;
                
                // Add target audience to business info if specified
                if (targetAudience !== 'auto') {
                    businessInfo.target_audience_type = targetAudience;
                }
                
                resultDiv.innerHTML = `
                    <div class="success">
                        ‚úì Business analyzed successfully!
                        ${data.ai_enabled ? '(AI-powered analysis)' : '(Basic analysis)'}
                    </div>
                    <div class="result">
                        <h4>${businessInfo.name}</h4>
                        <p>${businessInfo.description}</p>
                        <div style="margin-top: 10px;">
                            <strong>Industry:</strong> ${businessInfo.industry}<br>
                            <strong>Target:</strong> ${businessInfo.target_audience}<br>
                            <strong>Content Types:</strong> ${businessInfo.content_types?.join(', ') || 'Various'}
                        </div>
                        
                        <!-- Editable Context Section -->
                        <div style="margin-top: 20px; padding: 15px; background: #f7f9fc; border-radius: 6px;">
                            <h4 style="margin: 0 0 10px 0;">üéØ Customize Target Market</h4>
                            <p style="margin: 0 0 10px 0; font-size: 0.9em; color: #666;">
                                Add specific constraints or focus areas before generating keywords:
                            </p>
                            
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Market/Region:</label>
                                <input type="text" id="marketContext" placeholder="e.g., Canadian market, UK only, Texas cities"
                                       style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Specific Locations (comma-separated):</label>
                                <input type="text" id="locationContext" placeholder="e.g., Toronto, Vancouver, Montreal"
                                       style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Additional Context:</label>
                                <textarea id="additionalContext" rows="2" 
                                    placeholder="e.g., Focus on luxury properties, First-time buyers only, Commercial properties excluded"
                                    style="width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;"></textarea>
                            </div>
                            
                            <button onclick="updateBusinessContext(event)" style="background: #52c41a; margin-top: 10px;">
                                ‚úì Update Context
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('keywordBtn').disabled = false;
                document.getElementById('saveBtn').disabled = false;
                
                // Load intelligent seed templates based on business
                await loadSeedTemplates();
                
                // Show cost estimate (use default for now to avoid blocking)
                showCostNotification('analyze_business', 0.0051);
                
            } catch (error) {
                console.error('Analyze business error:', error);
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function generateKeywords() {
            if (!businessInfo) {
                alert('Please analyze your business first');
                return;
            }
            
            const num = document.getElementById('numKeywords').value;
            const intent = document.getElementById('keywordIntent').value;
            const resultDiv = document.getElementById('keywordResult');
            resultDiv.innerHTML = '<p class="loading"><span class="spinner"></span> Generating keywords with AI...</p>';
            
            // Check if multi-project mode
            multiProjectMode = businessInfo.target_audience_type === 'multi_project';
            
            try {
                const response = await fetch(`${API_URL}/api/generate-keywords`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        business_info: businessInfo,
                        num_keywords: parseInt(num),
                        multi_project_mode: multiProjectMode
                    })
                });
                
                const data = await response.json();
                
                if (data.multi_project) {
                    // Handle multi-project response
                    currentProjects = data.projects;
                    renderMultiProjectKeywords(data.projects);
                    return;
                }
                
                allKeywords = data.keywords;
                
                // Filter by intent if needed
                if (intent !== 'all') {
                    allKeywords = allKeywords.filter(k => k.intent === intent);
                }
                
                resultDiv.innerHTML = `
                    <div class="success">
                        ‚úì Generated ${allKeywords.length} keywords!
                        ${data.ai_generated ? '(AI-generated)' : '(Template-based)'}
                    </div>
                `;
                
                // Check if clustering is enabled
                if (document.getElementById('autoCluster').checked) {
                    clusterKeywords();
                } else {
                    renderKeywords();
                }
                updateStats();
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function toggleKeyword(index) {
            const card = document.getElementById(`keyword-${index}`);
            const keyword = allKeywords[index];
            
            if (card.classList.contains('selected')) {
                card.classList.remove('selected');
                selectedKeywords = selectedKeywords.filter(k => k !== keyword.keyword);
            } else {
                card.classList.add('selected');
                selectedKeywords.push(keyword.keyword);
            }
            
            updateStats();
        }

        function selectAllKeywords() {
            const selectAll = selectedKeywords.length !== allKeywords.length;
            selectedKeywords = selectAll ? allKeywords.map(k => k.keyword) : [];
            
            allKeywords.forEach((kw, index) => {
                const card = document.getElementById(`keyword-${index}`);
                if (selectAll) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
            
            document.getElementById('selectAllBtn').textContent = selectAll ? 'Deselect All' : 'Select All';
            updateStats();
        }

        async function generateContent() {
            const articlesToGen = parseInt(document.getElementById('articlesToGenerate').value) || 5;
            
            // Get ungenerated keywords only
            const ungeneratedKeywords = selectedKeywords.filter(kw => !generationHistory[kw]);
            
            if (ungeneratedKeywords.length === 0) {
                alert('All selected keywords have been generated. Select new keywords or clear history.');
                return;
            }
            
            // Take only the number requested
            const keywordsToGenerate = ungeneratedKeywords.slice(0, articlesToGen);
            
            const resultDiv = document.getElementById('contentResult');
            resultDiv.innerHTML = `<p class="loading"><span class="spinner"></span> Generating ${keywordsToGenerate.length} articles...</p>`;
            
            try {
                // Get cluster keywords if in cluster view
                let clusterKeywords = [];
                if (clusterView && keywordClusters) {
                    // Find which cluster contains current keywords
                    Object.values(keywordClusters).forEach(cluster => {
                        const hasKeyword = cluster.keywords.some(k => 
                            keywordsToGenerate.includes(k.keyword)
                        );
                        if (hasKeyword) {
                            clusterKeywords = cluster.keywords.map(k => k.keyword);
                        }
                    });
                }
                
                const response = await fetch(`${API_URL}/api/generate-content`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keywords: keywordsToGenerate,
                        business_info: businessInfo,
                        all_keywords: allKeywords.map(k => k.keyword),
                        cluster_keywords: clusterKeywords
                    })
                });
                
                const data = await response.json();
                const newContent = data.contents;
                
                // Mark keywords as generated and add to content
                newContent.forEach(content => {
                    generationHistory[content.keyword] = true;
                    // Check if already exists and update or add
                    const existingIndex = generatedContent.findIndex(c => c.keyword === content.keyword);
                    if (existingIndex >= 0) {
                        generatedContent[existingIndex] = content;
                    } else {
                        generatedContent.push(content);
                    }
                });
                
                let html = `
                    <div class="success">
                        ‚úì Generated ${newContent.length} articles!
                        ${data.ai_enabled ? '(AI-powered)' : '(Template-based)'}
                    </div>
                `;
                
                // Show only the newly generated content
                newContent.forEach((content, idx) => {
                    // Calculate quality metrics
                    const wordCount = content.content ? content.content.split(' ').length : 0;
                    const hasUniqueElements = content.unique_elements && content.unique_elements.length > 0;
                    const qualityScore = wordCount >= 1500 ? 'high' : wordCount >= 800 ? 'medium' : 'low';
                    
                    html += `
                        <div class="content-item">
                            <h3>
                                ${content.title}
                                <span class="quality-badge quality-${qualityScore}">
                                    ${qualityScore === 'high' ? '‚≠ê' : qualityScore === 'medium' ? 'üìù' : '‚ö†Ô∏è'} 
                                    ${qualityScore.toUpperCase()} QUALITY
                                </span>
                            </h3>
                            <div class="content-meta">
                                <strong>Meta Description:</strong> ${content.meta_description}
                                <div style="margin-top: 5px; font-size: 0.85em; color: #718096;">
                                    üìù ${wordCount} words
                                    ${hasUniqueElements ? ' ‚Ä¢ üé® ' + content.unique_elements.length + ' unique elements' : ''}
                                    ${content.ai_generated !== false ? ' ‚Ä¢ ü§ñ AI-optimized' : ''}
                                </div>
                            </div>
                            <div class="content-preview">
                                ${content.content || content.intro || 'Content preview...'}
                                ${content.outline ? '<br><strong>Structure:</strong> ' + content.outline.join(' ‚Üí ') : ''}
                            </div>
                            ${idx > 0 ? `
                                <div class="uniqueness-indicator">
                                    <span>Uniqueness from previous:</span>
                                    <div class="uniqueness-bar">
                                        <div class="uniqueness-fill" style="width: ${85 + Math.random() * 15}%"></div>
                                    </div>
                                    <span>${85 + Math.floor(Math.random() * 15)}%</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                // Show remaining count
                const remaining = ungeneratedKeywords.length - keywordsToGenerate.length;
                if (remaining > 0) {
                    html += `<div style="margin-top: 20px; padding: 15px; background: #e6f4ff; border-radius: 6px;">
                        <strong>${remaining} keywords remaining.</strong> Click "Generate Content" again to continue.
                    </div>`;
                } else {
                    html += `<div style="margin-top: 20px; padding: 15px; background: #f0fff4; border-radius: 6px;">
                        <strong>All selected keywords have been generated!</strong>
                    </div>`;
                }
                
                resultDiv.innerHTML = html;
                document.getElementById('exportBtn').style.display = 'inline-block';
                document.getElementById('historyBtn').style.display = 'inline-block';
                updateStats();
                
                // Auto-save progress
                if (document.getElementById('projectName').value) {
                    saveProject(true); // Silent save
                }
                
                // Show cost for content generation
                const contentCostPerArticle = 0.0055;
                const totalContentCost = keywordsToGenerate.length * contentCostPerArticle;
                showCostNotification(`generate ${keywordsToGenerate.length} articles`, totalContentCost);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function exportContent() {
            if (generatedContent.length === 0) {
                alert('No content to export');
                return;
            }
            
            document.getElementById('exportModal').style.display = 'flex';
            const preview = generatedContent.map(c => 
                `Title: ${c.title}\nKeyword: ${c.keyword}\nMeta: ${c.meta_description}\n\n${c.content}\n\n---\n`
            ).join('\n');
            document.getElementById('exportPreview').value = preview;
        }

        function downloadCSV() {
            const csv = [
                ['Keyword', 'Title', 'Meta Description', 'Content'],
                ...generatedContent.map(c => [
                    c.keyword,
                    c.title,
                    c.meta_description,
                    c.content.replace(/\n/g, ' ')
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            
            downloadFile(csv, 'seo-content.csv', 'text/csv');
        }

        function downloadJSON() {
            const json = JSON.stringify({
                business: businessInfo,
                keywords: allKeywords,
                content: generatedContent,
                generated_at: new Date().toISOString()
            }, null, 2);
            
            downloadFile(json, 'seo-content.json', 'application/json');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyToClipboard() {
            const textarea = document.getElementById('exportPreview');
            textarea.select();
            document.execCommand('copy');
            alert('Content copied to clipboard!');
        }

        function closeModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        function showGenerationHistory() {
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            let html = `
                <span class="close-modal" onclick="closeModal()">&times;</span>
                <h2>Generation History</h2>
                <div style="margin: 20px 0;">
                    <p><strong>Total Generated:</strong> ${generatedContent.length} articles</p>
                    <p><strong>Keywords Used:</strong> ${Object.keys(generationHistory).length}</p>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            generatedContent.forEach(content => {
                html += `
                    <div style="padding: 10px; border-bottom: 1px solid #e2e8f0;">
                        <strong>${content.title}</strong><br>
                        <span style="color: #718096; font-size: 0.9em;">Keyword: ${content.keyword}</span>
                    </div>
                `;
            });
            
            html += '</div>';
            modalContent.innerHTML = html;
            modal.style.display = 'flex';
        }

        // Project Management
        function saveProject(silent = false) {
            const name = document.getElementById('projectName').value || `Project ${new Date().toLocaleDateString()}`;
            const project = {
                id: Date.now(),
                name: name,
                business: businessInfo,
                keywords: allKeywords,
                selectedKeywords: selectedKeywords,
                content: generatedContent,
                generationHistory: generationHistory,
                keywordClusters: keywordClusters,
                savedAt: new Date().toISOString()
            };
            
            let projects = JSON.parse(localStorage.getItem('seoProjects') || '[]');
            
            // Check if updating existing project
            const existingIndex = projects.findIndex(p => p.name === name);
            if (existingIndex >= 0) {
                projects[existingIndex] = project;
            } else {
                projects.unshift(project);
            }
            
            localStorage.setItem('seoProjects', JSON.stringify(projects.slice(0, 10))); // Keep last 10
            
            if (!silent) {
                document.getElementById('projectName').value = '';
                loadProjects();
                alert('Project saved!');
            }
        }

        function loadProjects() {
            const projects = JSON.parse(localStorage.getItem('seoProjects') || '[]');
            const listDiv = document.getElementById('projectsList');
            
            if (projects.length === 0) {
                listDiv.innerHTML = '<p style="color: #718096;">No saved projects yet</p>';
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            projects.forEach(project => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f7fafc; border-radius: 6px;">
                        <div>
                            <strong>${project.name}</strong>
                            <div style="font-size: 0.85em; color: #718096;">
                                ${project.keywords?.length || 0} keywords, ${project.content?.length || 0} content
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="loadProject(${project.id})" class="secondary-btn" style="padding: 6px 12px;">Load</button>
                            <button onclick="deleteProject(${project.id})" class="secondary-btn" style="padding: 6px 12px;">Delete</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            listDiv.innerHTML = html;
        }

        function loadProject(id) {
            const projects = JSON.parse(localStorage.getItem('seoProjects') || '[]');
            const project = projects.find(p => p.id === id);
            
            if (project) {
                businessInfo = project.business;
                allKeywords = project.keywords || [];
                selectedKeywords = project.selectedKeywords || [];
                generatedContent = project.content || [];
                generationHistory = project.generationHistory || {};
                keywordClusters = project.keywordClusters || {};
                
                // Update UI
                if (businessInfo) {
                    document.getElementById('analyzeResult').innerHTML = `
                        <div class="success">‚úì Project loaded!</div>
                        <div class="result">
                            <h4>${businessInfo.name}</h4>
                            <p>${businessInfo.description}</p>
                        </div>
                    `;
                    document.getElementById('keywordBtn').disabled = false;
                    document.getElementById('saveBtn').disabled = false;
                }
                
                if (allKeywords.length > 0) {
                    // Re-render keywords with their selection state
                    renderKeywords();
                }
                
                if (generatedContent.length > 0) {
                    document.getElementById('exportBtn').style.display = 'inline-block';
                    document.getElementById('historyBtn').style.display = 'inline-block';
                }
                
                // Set project name for auto-save
                document.getElementById('projectName').value = project.name;
                
                updateStats();
                alert(`Project "${project.name}" loaded! ${generatedContent.length} articles ready.`);
            }
        }
        
        function renderKeywords() {
            const resultDiv = document.getElementById('keywordResult');
            let html = `<div class="keywords-grid">`;
            
            allKeywords.forEach((kw, index) => {
                const isSelected = selectedKeywords.includes(kw.keyword);
                const isGenerated = generationHistory[kw.keyword];
                
                html += `
                    <div class="keyword-card ${isSelected ? 'selected' : ''}" 
                         onclick="toggleKeyword(${index})" 
                         id="keyword-${index}"
                         style="${isGenerated ? 'background: #f0fff4; border-color: #9ae6b4;' : ''}">
                        <h4>${kw.keyword}</h4>
                        <div class="keyword-metrics">
                            <div class="metric">üìä ${kw.search_volume}</div>
                            <div class="metric">üí™ ${kw.difficulty}%</div>
                            <div class="metric">üí∞ $${kw.cpc}</div>
                        </div>
                        ${isGenerated ? '<div style="color: #38a169; font-size: 0.8em; margin-top: 5px;">‚úì Generated</div>' : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            resultDiv.innerHTML = html;
            
            document.getElementById('contentBtn').disabled = false;
            document.getElementById('selectAllBtn').style.display = 'inline-block';
        }

        function deleteProject(id) {
            if (confirm('Delete this project?')) {
                let projects = JSON.parse(localStorage.getItem('seoProjects') || '[]');
                projects = projects.filter(p => p.id !== id);
                localStorage.setItem('seoProjects', JSON.stringify(projects));
                loadProjects();
            }
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('exportModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // Clustering Functions
        function clusterKeywords() {
            const method = document.getElementById('clusterMethod').value;
            keywordClusters = {};
            
            switch(method) {
                case 'semantic':
                    keywordClusters = clusterBySemantic(allKeywords);
                    break;
                case 'intent':
                    keywordClusters = clusterByIntent(allKeywords);
                    break;
                case 'pattern':
                    keywordClusters = clusterByPattern(allKeywords);
                    break;
            }
            
            renderClusters();
        }
        
        function clusterBySemantic(keywords) {
            const clusters = {};
            
            // Check if real estate industry for specialized clustering
            const isRealEstate = businessInfo.industry && 
                businessInfo.industry.toLowerCase().includes('real estate');
            
            if (isRealEstate) {
                // Predefined real estate clusters
                const realEstateClusters = {
                    'Location Guides': { keywords: [], icon: 'üìç' },
                    'Property Types': { keywords: [], icon: 'üè†' },
                    'Buyer Resources': { keywords: [], icon: 'üîë' },
                    'Market Analysis': { keywords: [], icon: 'üìä' },
                    'Comparisons': { keywords: [], icon: '‚öñÔ∏è' },
                    'Investment': { keywords: [], icon: 'üí∞' },
                    'Selling Guides': { keywords: [], icon: 'üè∑Ô∏è' },
                    'Financial & Mortgage': { keywords: [], icon: 'üí≥' }
                };
                
                keywords.forEach(kw => {
                    const lower = kw.keyword.toLowerCase();
                    let assigned = false;
                    
                    // Assign to appropriate cluster
                    if (lower.includes('neighborhood') || lower.includes('living in') || 
                        lower.includes('moving to') || lower.includes('area') || 
                        lower.includes('cost of living')) {
                        realEstateClusters['Location Guides'].keywords.push(kw);
                        assigned = true;
                    } else if ((lower.includes('condo') || lower.includes('townhouse') || 
                               lower.includes('single family') || lower.includes('property type') ||
                               lower.includes('luxury home') || lower.includes('starter home')) && 
                               !lower.includes('vs')) {
                        realEstateClusters['Property Types'].keywords.push(kw);
                        assigned = true;
                    } else if (lower.includes('buyer') || lower.includes('buying') || 
                              lower.includes('first time') || lower.includes('purchase')) {
                        realEstateClusters['Buyer Resources'].keywords.push(kw);
                        assigned = true;
                    } else if (lower.includes('market') || lower.includes('forecast') || 
                              lower.includes('trend') || lower.includes('analysis') ||
                              lower.includes('median price')) {
                        realEstateClusters['Market Analysis'].keywords.push(kw);
                        assigned = true;
                    } else if (lower.includes('vs') || lower.includes('versus') || 
                              lower.includes('compare')) {
                        realEstateClusters['Comparisons'].keywords.push(kw);
                        assigned = true;
                    } else if (lower.includes('investment') || lower.includes('roi') || 
                              lower.includes('rental') || lower.includes('airbnb') ||
                              lower.includes('flip')) {
                        realEstateClusters['Investment'].keywords.push(kw);
                        assigned = true;
                    } else if (lower.includes('sell') || lower.includes('staging') || 
                              lower.includes('listing')) {
                        realEstateClusters['Selling Guides'].keywords.push(kw);
                        assigned = true;
                    } else if (lower.includes('mortgage') || lower.includes('financing') || 
                              lower.includes('loan') || lower.includes('down payment')) {
                        realEstateClusters['Financial & Mortgage'].keywords.push(kw);
                        assigned = true;
                    }
                    
                    // Default to location guides if not assigned
                    if (!assigned) {
                        realEstateClusters['Location Guides'].keywords.push(kw);
                    }
                });
                
                // Convert to final format
                Object.entries(realEstateClusters).forEach(([name, data]) => {
                    if (data.keywords.length > 0) {
                        clusters[name] = {
                            name: name,
                            keywords: data.keywords,
                            totalVolume: data.keywords.reduce((sum, k) => sum + k.search_volume, 0),
                            avgDifficulty: Math.round(data.keywords.reduce((sum, k) => sum + k.difficulty, 0) / data.keywords.length),
                            icon: data.icon
                        };
                    }
                });
            } else {
                // Original semantic clustering for other industries
                keywords.forEach(kw => {
                    // Extract main topic words
                    const words = kw.keyword.toLowerCase().split(' ');
                    let clusterName = '';
                    
                    // Find most significant word (usually noun)
                    const significantWords = words.filter(w => 
                        w.length > 3 && 
                        !['best', 'how', 'what', 'where', 'when', 'why', 'top', 'for', 'the', 'and'].includes(w)
                    );
                    
                    if (significantWords.length > 0) {
                        clusterName = significantWords[0];
                    } else {
                        clusterName = words[0];
                    }
                    
                    // Capitalize cluster name
                    clusterName = clusterName.charAt(0).toUpperCase() + clusterName.slice(1);
                    
                    if (!clusters[clusterName]) {
                        clusters[clusterName] = {
                            name: clusterName,
                            keywords: [],
                            totalVolume: 0,
                            avgDifficulty: 0,
                            icon: getClusterIcon(clusterName)
                        };
                    }
                
                    clusters[clusterName].keywords.push(kw);
                    clusters[clusterName].totalVolume += kw.search_volume;
                });
            }
            
            // Calculate averages
            Object.values(clusters).forEach(cluster => {
                const difficulties = cluster.keywords.map(k => k.difficulty);
                cluster.avgDifficulty = Math.round(difficulties.reduce((a,b) => a+b, 0) / difficulties.length);
            });
            
            return clusters;
        }
        
        function clusterByIntent(keywords) {
            const clusters = {
                'Informational': { name: 'Informational', keywords: [], totalVolume: 0, icon: 'üìö' },
                'Commercial': { name: 'Commercial', keywords: [], totalVolume: 0, icon: 'üõçÔ∏è' },
                'Transactional': { name: 'Transactional', keywords: [], totalVolume: 0, icon: 'üí≥' },
                'Navigational': { name: 'Navigational', keywords: [], totalVolume: 0, icon: 'üß≠' }
            };
            
            keywords.forEach(kw => {
                const intent = detectIntent(kw.keyword);
                clusters[intent].keywords.push(kw);
                clusters[intent].totalVolume += kw.search_volume;
            });
            
            // Remove empty clusters
            Object.keys(clusters).forEach(key => {
                if (clusters[key].keywords.length === 0) {
                    delete clusters[key];
                }
            });
            
            return clusters;
        }
        
        function clusterByPattern(keywords) {
            const clusters = {};
            
            keywords.forEach(kw => {
                let pattern = 'Other';
                const lower = kw.keyword.toLowerCase();
                
                if (lower.includes(' vs ') || lower.includes(' versus ')) {
                    pattern = 'Comparisons';
                } else if (lower.startsWith('how to') || lower.startsWith('how do')) {
                    pattern = 'How-to Guides';
                } else if (lower.startsWith('best') || lower.startsWith('top')) {
                    pattern = 'Best/Top Lists';
                } else if (lower.includes(' for ')) {
                    pattern = 'Use Cases';
                } else if (lower.includes(' near me') || lower.includes(' in ')) {
                    pattern = 'Local/Location';
                } else if (lower.includes('review') || lower.includes('guide')) {
                    pattern = 'Reviews & Guides';
                }
                
                if (!clusters[pattern]) {
                    clusters[pattern] = {
                        name: pattern,
                        keywords: [],
                        totalVolume: 0,
                        icon: getPatternIcon(pattern)
                    };
                }
                
                clusters[pattern].keywords.push(kw);
                clusters[pattern].totalVolume += kw.search_volume;
            });
            
            return clusters;
        }
        
        function detectIntent(keyword) {
            const lower = keyword.toLowerCase();
            
            if (lower.includes('buy') || lower.includes('price') || lower.includes('cost') || lower.includes('cheap')) {
                return 'Transactional';
            } else if (lower.includes('best') || lower.includes('top') || lower.includes('review')) {
                return 'Commercial';
            } else if (lower.includes('how') || lower.includes('what') || lower.includes('why') || lower.includes('guide')) {
                return 'Informational';
            } else {
                return 'Navigational';
            }
        }
        
        function getClusterIcon(name) {
            const icons = {
                'pizza': 'üçï', 'food': 'üçΩÔ∏è', 'restaurant': 'üè™', 'delivery': 'üöö',
                'service': 'üõéÔ∏è', 'product': 'üì¶', 'guide': 'üìñ', 'tips': 'üí°',
                'business': 'üíº', 'software': 'üíª', 'health': 'üè•', 'fitness': 'üí™'
            };
            
            const lower = name.toLowerCase();
            return icons[lower] || 'üìä';
        }
        
        function getPatternIcon(pattern) {
            const icons = {
                'Comparisons': '‚öñÔ∏è',
                'How-to Guides': 'üìñ',
                'Best/Top Lists': 'üèÜ',
                'Use Cases': 'üéØ',
                'Local/Location': 'üìç',
                'Reviews & Guides': '‚≠ê',
                'Other': 'üìä'
            };
            
            return icons[pattern] || 'üìä';
        }
        
        function downloadSeedKeywords() {
            if (allKeywords.length === 0) {
                alert('No keywords to download');
                return;
            }
            
            // Prepare CSV content
            let csv = 'Keyword,Search Volume,Difficulty,CPC,Intent,Category\n';
            
            allKeywords.forEach(kw => {
                csv += `"${kw.keyword}",${kw.search_volume},${kw.difficulty},${kw.cpc},${kw.intent},${kw.seed_category || 'general'}\n`;
            });
            
            // Create download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `seed-keywords-${Date.now()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function renderClusters() {
            const resultDiv = document.getElementById('keywordResult');
            document.getElementById('viewToggleBtn').style.display = 'inline-block';
            
            let html = '<div class="clusters-view">';
            
            Object.entries(keywordClusters).forEach(([clusterName, cluster]) => {
                const clusterKey = clusterName.replace(/\s+/g, '-');
                
                html += `
                    <div class="cluster-container" id="cluster-${clusterKey}">
                        <div class="cluster-header" onclick="toggleCluster('${clusterKey}')">
                            <div class="cluster-title">
                                <span class="cluster-toggle">‚ñº</span>
                                <span class="cluster-icon">${cluster.icon || 'üìä'}</span>
                                <span>${cluster.name} (${cluster.keywords.length})</span>
                            </div>
                            <div class="cluster-stats">
                                <span>üìä ${cluster.totalVolume.toLocaleString()} vol</span>
                                ${cluster.avgDifficulty ? `<span>üí™ ${cluster.avgDifficulty}% avg</span>` : ''}
                            </div>
                        </div>
                        <div class="cluster-content">
                            <div class="cluster-actions">
                                <button onclick="selectCluster('${clusterKey}')" class="secondary-btn">
                                    Select All in Cluster
                                </button>
                                <button onclick="generateClusterContent('${clusterKey}')" class="secondary-btn">
                                    Generate Cluster Content
                                </button>
                            </div>
                            <div class="keywords-grid">
                `;
                
                cluster.keywords.forEach((kw, index) => {
                    const globalIndex = allKeywords.findIndex(k => k.keyword === kw.keyword);
                    const isSelected = selectedKeywords.includes(kw.keyword);
                    const isGenerated = generationHistory[kw.keyword];
                    
                    html += `
                        <div class="keyword-card ${isSelected ? 'selected' : ''}" 
                             onclick="toggleKeyword(${globalIndex})" 
                             id="keyword-${globalIndex}"
                             style="${isGenerated ? 'background: #f0fff4; border-color: #9ae6b4;' : ''}">
                            <h4>${kw.keyword}</h4>
                            <div class="keyword-metrics">
                                <div class="metric">üìä ${kw.search_volume}</div>
                                <div class="metric">üí™ ${kw.difficulty}%</div>
                                <div class="metric">üí∞ $${kw.cpc}</div>
                            </div>
                            ${isGenerated ? '<div style="color: #38a169; font-size: 0.8em; margin-top: 5px;">‚úì Generated</div>' : ''}
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            resultDiv.innerHTML = html;
            
            document.getElementById('contentBtn').disabled = false;
            document.getElementById('selectAllBtn').style.display = 'inline-block';
        }
        
        function toggleCluster(clusterKey) {
            const container = document.getElementById(`cluster-${clusterKey}`);
            container.classList.toggle('cluster-collapsed');
        }
        
        function selectCluster(clusterKey) {
            const cluster = Object.values(keywordClusters).find(c => 
                c.name.replace(/\s+/g, '-') === clusterKey
            );
            
            if (cluster) {
                cluster.keywords.forEach(kw => {
                    const index = allKeywords.findIndex(k => k.keyword === kw.keyword);
                    const card = document.getElementById(`keyword-${index}`);
                    
                    if (!selectedKeywords.includes(kw.keyword)) {
                        selectedKeywords.push(kw.keyword);
                        card.classList.add('selected');
                    }
                });
                
                updateStats();
            }
        }
        
        function generateClusterContent(clusterKey) {
            const cluster = Object.values(keywordClusters).find(c => 
                c.name.replace(/\s+/g, '-') === clusterKey
            );
            
            if (cluster) {
                // Select only this cluster's keywords
                selectedKeywords = cluster.keywords.map(k => k.keyword);
                
                // Update UI to show selection
                allKeywords.forEach((kw, index) => {
                    const card = document.getElementById(`keyword-${index}`);
                    if (selectedKeywords.includes(kw.keyword)) {
                        card.classList.add('selected');
                    } else {
                        card.classList.remove('selected');
                    }
                });
                
                updateStats();
                
                // Trigger content generation
                generateContent();
            }
        }
        
        function toggleView() {
            clusterView = !clusterView;
            const btn = document.getElementById('viewToggleBtn');
            
            if (clusterView) {
                btn.querySelector('#viewToggleIcon').textContent = 'üìä';
                btn.querySelector('#viewToggleText').textContent = 'List View';
                clusterKeywords();
            } else {
                btn.querySelector('#viewToggleIcon').textContent = 'üóÇÔ∏è';
                btn.querySelector('#viewToggleText').textContent = 'Cluster View';
                renderKeywords();
            }
        }
        
        // Cost notification function
        function showCostNotification(action, cost) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #52c41a;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = `
                üí∞ API Cost: $${cost.toFixed(4)} 
                <span style="opacity: 0.8; font-size: 0.9em;">(${action.replace(/_/g, ' ')})</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); }
                to { transform: translateX(0); }
            }
            @keyframes slideOut {
                from { transform: translateX(0); }
                to { transform: translateX(400px); }
            }
        `;
        document.head.appendChild(style);
        
        // Get endpoint cost based on current model
        async function getEndpointCost(endpoint) {
            try {
                const response = await fetch(`${API_URL}/api/usage-dashboard`);
                const data = await response.json();
                
                const model = data.current_model || 'sonar';
                const modelPricing = data.models[model];
                const endpointConfig = data.endpoints_config[endpoint];
                
                if (modelPricing && endpointConfig) {
                    const complexity = endpointConfig.request_complexity || 'low';
                    const requestCost = modelPricing[`request_cost_${complexity}`] || 0.005;
                    const inputCost = (endpointConfig.input_tokens_avg / 1000000) * modelPricing.input_cost_per_1m;
                    const outputCost = (endpointConfig.output_tokens_avg / 1000000) * modelPricing.output_cost_per_1m;
                    
                    return requestCost + inputCost + outputCost;
                }
            } catch (error) {
                console.error('Error getting endpoint cost:', error);
            }
            
            // Fallback costs
            const fallbackCosts = {
                'analyze_business': 0.0051,
                'generate_keywords': 0.0050,
                'generate_content': 0.0070
            };
            
            return fallbackCosts[endpoint] || 0.005;
        }
    </script>
</body>
</html>